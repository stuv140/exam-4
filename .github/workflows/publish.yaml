name: 'C++ CI'

on:
  push:
    branches:
      - doc
      - feature/github_actions

permissions:
  contents: write # Необходимо для push'а на gh-pages

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: doc
          submodules: recursive
          repository: stuv140/exam-4
          token: ${{ secrets.ASSESS_TOKEN }} # <-- ИСПОЛЬЗУЕТСЯ ВАШ НОВЫЙ СЕКРЕТНЫЙ ТОКЕН
          fetch-depth: 0
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          set-safe-directory: true

      # --- Настройка Git для push ---
      - name: Configure Git for push
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          # Предполагается, что ASSESS_TOKEN имеет права на запись.
          # Если ASSESS_TOKEN - это PAT, он может быть использован здесь.
          # Если ASSESS_TOKEN - это GITHUB_TOKEN, убедитесь, что он имеет права write.
          git remote set-url origin https://x-access-token:${{ secrets.ASSESS_TOKEN }}@github.com/stuv140/exam-4.git
          # ВАЖНО: Если ASSESS_TOKEN это НЕ GITHUB_TOKEN, и он не работает
          # как x-access-token, попробуйте так (если ASSESS_TOKEN - ваш PAT):
          # git remote set-url origin https://${{ secrets.ASSESS_TOKEN }}@github.com/stuv140/exam-4.git

      # --- Генерация документации ---
      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install doxygen -y
      - name: Generate documentation
        run: doxygen Doxyfile # Убедитесь, что Doxyfile существует
        working-directory: ${{ github.workspace }}

      # --- Публикация GH-PAGES ---
      - name: Publish GH-Pages
        uses: tsunematsu21/actions-publish-gh-pages@v1.0.2
        with:
          dir: docs/html
          branch: gh-pages
        env:
          # Важно: Убедитесь, что ASSESS_TOKEN имеет права на запись для gh-pages.
          # Если ASSESS_TOKEN - это PAT, вы можете передать его сюда.
          # Если это GITHUB_TOKEN, убедитесь, что он настроен для записи.
          GITHUB_TOKEN: ${{ secrets.ASSESS_TOKEN }} # <-- Передаем ASSESS_TOKEN в env для action
