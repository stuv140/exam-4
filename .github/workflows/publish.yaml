name: 'C++ CI'

on:
  push:
    branches:
      - doc
      - feature/github_actions

permissions:
  contents: write # Необходимо для push'а на gh-pages

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: doc
          submodules: recursive
          repository: stuv140/exam-4
          token: ${{ secrets.ASSESS_TOKEN }} # <-- Ваш секретный токен для HTTPS
          fetch-depth: 0
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          set-safe-directory: true
          # ssh-strict: true  <-- Удалено (или закомментировано)
          # ssh-user: git      <-- Удалено (или закомментировано)

      # --- Настройка Git для push ---
      - name: Configure Git for push
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          # Используем ASSESS_TOKEN для HTTPS URL
          git remote set-url origin https://x-access-token:${{ secrets.ASSESS_TOKEN }}@github.com/stuv140/exam-4.git
          # Если ASSESS_TOKEN - это обычный PAT, попробуйте:
          # git remote set-url origin https://${{ secrets.ASSESS_TOKEN }}@github.com/stuv140/exam-4.git

      # --- Генерация документации ---
      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install doxygen -y
      - name: Generate documentation
        run: doxygen Doxyfile # Убедитесь, что Doxyfile существует
        working-directory: ${{ github.workspace }}

      # --- Публикация GH-PAGES ---
      - name: Publish GH-Pages
        uses: tsunematsu21/actions-publish-gh-pages@v1.0.2
        with:
          dir: docs/html
          branch: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.ASSESS_TOKEN }} # Передаем ASSESS_TOKEN
